{% extends "base1.html" %}

{% block title %}Model Explainability - Safaricom Portal{% endblock %}

{% block content %}
<div class="content-header">
    <h1><i class="fas fa-brain"></i> Model Explainability</h1>
    <p>Understanding how our ARIMA time-series model makes predictions based on historical claims data</p>
</div>

<div class="content-body">

    <!-- Forecast Summary -->
    <div class="card">
        <div class="card-header">
            <h3>Forecast Summary</h3>
        </div>
        <div class="card-body">
            {% if forecasted_next_month %}
                <p><b>Next Month's Forecasted Total Claims:</b> {{ forecasted_next_month }}</p>
                <small>This forecast is generated using the same ARIMA (1,1,1) model explained below.</small>
            {% else %}
                <div class="alert alert-warning">No forecast available for the selected filters.</div>
            {% endif %}
        </div>
    </div>

    {% if error %}
        <div class="alert alert-danger">{{ error }}</div>
    {% endif %}


    <!-- SHAP Value Analysis -->
    <div class="card">
        <div class="card-header">
            <h3>SHAP Value Analysis (ARIMA Lag Features)</h3>
        </div>
        <div class="card-body">
            {% if visualizations.shap_values %}
                {{ visualizations.shap_values|safe }}
            {% else %}
                <div class="alert alert-warning">No SHAP values available</div>
            {% endif %}
            
            <div class="shap-description">
                <h4>About SHAP Values for ARIMA</h4>
                <p>SHAP values explain the contribution of each lagged feature (<b>Lag 1, Lag 2, Lag 3</b>) to the model's forecast. 
                   A higher absolute SHAP value means that lag had a greater influence on the prediction.</p>
                <p><b>Lag 1</b> = Last month's claims amount  
                   <b>Lag 2</b> = Claims amount two months ago  
                   <b>Lag 3</b> = Claims amount three months ago</p>
            </div>
        </div>
    </div>
    
    <!-- Partial Dependence Plot -->
    <div class="row">
        <div class="col-md-6">
            <div class="card">
                <div class="card-header">
                    <h3>Partial Dependence Plot</h3>
                </div>
                <div class="card-body">
                    {% if visualizations.partial_dependence %}
                        {{ visualizations.partial_dependence|safe }}
                    {% else %}
                        <div class="alert alert-warning">No partial dependence data available</div>
                    {% endif %}
                </div>
            </div>
        </div>

        <!-- Feature Interactions -->
        <div class="col-md-6">
            <div class="card">
                <div class="card-header">
                    <h3>Feature Interactions</h3>
                </div>
                <div class="card-body">
                    <div class="interaction-placeholder">
                        <p>Interaction analysis is not applicable for pure time-series ARIMA models, 
                           as features are derived only from lagged target values.</p>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Model Summary -->
    <div class="card">
        <div class="card-header">
            <h3>Model Summary</h3>
        </div>
        <div class="card-body">
            <p>The claims prediction model is an <b>ARIMA (1,1,1)</b> time-series model trained on 
               monthly aggregated claims amounts from the database. It uses lag features (<b>Lag 1, Lag 2, Lag 3</b>) 
               representing the last 3 months’ values to forecast the next period.</p>
            <p>SHAP values help us understand which lag periods have the most influence 
               on the model’s predictions. Partial dependence plots show how changes in 
               a particular lag value affect the forecasted claim amount.</p>
        </div>
    </div>
</div>

<style>
    .content-header { margin-bottom: 2rem; }
    .content-header h1 { color: #1BB64F; margin-bottom: 0.5rem; }
    .content-header p { color: #666; }

    .card {
        background: white;
        border-radius: 10px;
        box-shadow: 0 2px 10px rgba(0,0,0,0.05);
        margin-bottom: 2rem;
        border: 1px solid #e3e8ee;
    }
    .card-header { padding: 1.5rem; border-bottom: 1px solid #e3e8ee; }
    .card-header h3 { margin: 0; font-size: 1.2rem; }
    .card-body { padding: 1.5rem; }

    .shap-description { margin-top: 2rem; padding-top: 1rem; border-top: 1px solid #e3e8ee; }
    .shap-description h4 { color: #1BB64F; margin-bottom: 0.8rem; }
    .shap-description p { color: #666; margin-bottom: 0.5rem; }

    .interaction-placeholder {
        background: #f7fdf9;
        border-radius: 8px;
        padding: 1rem;
        border: 1px solid #e3e8ee;
        color: #555;
    }
</style>

<script>
    // Make Plotly charts responsive
    window.addEventListener('resize', function() {
        if (typeof Plotly !== 'undefined') {
            document.querySelectorAll('.js-plotly-plot').forEach(function(chart) {
                Plotly.Plots.resize(chart);
            });
        }
    });
</script>
{% endblock %}
