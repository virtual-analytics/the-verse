{% extends "base.html" %}
{% load static %}
{% load custom_filters %}

{% block title %}Potential Cases - Minet Portal{% endblock %}

{% block extra_head %}
<link rel="stylesheet" href="https://cdn.datatables.net/1.11.5/css/dataTables.bootstrap5.min.css">
<style>
    /* Your styles from the example, slightly modified for this template */
    .content-header {
        margin-bottom: 2rem;
        border-bottom: 2px solid #e3e8ee;
        padding-bottom: 0.5rem;
    }
    .content-header h1 {
        color: #1BB64F;
        font-weight: 700;
        margin-bottom: 0.4rem;
        font-size: 1.6rem;
    }
    .content-header p {
        color: #666;
        font-size: 0.95rem;
    }
    
    .fraud-filters {
        display: flex;
        gap: 1rem;
        margin-bottom: 1.5rem;
        flex-wrap: wrap;
        align-items: flex-end;
    }
    .filter-group {
        display: flex;
        flex-direction: column;
    }
    .filter-group label {
        font-size: 0.85rem;
        color: #555;
        margin-bottom: 0.25rem;
    }
    .form-select {
        padding: 0.45rem 1rem;
        border-radius: 6px;
        border: 1px solid #ddd;
        background-color: #f9f9f9;
        min-width: 150px;
        transition: border 0.3s ease;
    }
    .form-select:focus {
        outline: none;
        border: 1px solid #1BB64F;
        background-color: #fff;
    }
    .btn-apply {
        background: #1BB64F;
        color: white;
        border: none;
        border-radius: 6px;
        padding: 0.5rem 1.5rem;
        font-weight: 500;
        cursor: pointer;
        height: 40px;
        transition: background 0.3s ease;
    }
    .btn-apply:hover {
        background: #159a40;
    }
    
    .card {
        background: white;
        border-radius: 10px;
        box-shadow: 0 2px 10px rgba(0,0,0,0.05);
        margin-bottom: 2rem;
        border: 1px solid #e3e8ee;
    }
    .card-header {
        padding: 1rem 1.5rem;
        border-bottom: 1px solid #e3e8ee;
        display: flex;
        justify-content: space-between;
        align-items: center;
    }
    .card-header h3 {
        margin: 0;
        font-size: 1.2rem;
        font-weight: 600;
    }
    .card-body {
        padding: 1.2rem 1.5rem;
    }
    
    .btn-export {
        background: #f0f7f2;
        color: #1BB64F;
        border: none;
        border-radius: 6px;
        padding: 0.5rem 1rem;
        font-weight: 500;
        cursor: pointer;
        transition: background 0.3s ease;
    }
    .btn-export:hover {
        background: #1BB64F;
        color: white;
    }
    
    .table-responsive {
        overflow-x: auto;
    }
    .fraud-cases-table {
        width: 100%;
        border-collapse: collapse;
        font-size: 0.9rem;
    }
    .fraud-cases-table th, 
    .fraud-cases-table td {
        padding: 0.75rem 1rem;
        text-align: left;
        border-bottom: 1px solid #e3e8ee;
    }
    .fraud-cases-table th {
        background: #f7fdf9;
        font-weight: 600;
        color: #333;
    }
    .fraud-cases-table tr:hover {
        background: #f0f7f2;
    }
    input[type="checkbox"] {
        cursor: pointer;
    }
    
    .risk-score {
        --hue: calc((1 - var(--score)) * 120);
        background: hsl(var(--hue), 80%, 90%);
        color: hsl(var(--hue), 80%, 25%);
        padding: 0.3rem 0.5rem;
        border-radius: 4px;
        font-weight: 600;
        display: inline-block;
        min-width: 50px;
        text-align: center;
        font-size: 0.85rem;
    }
    
    .status-badge {
        font-size: 0.75rem;
        padding: 0.3rem 0.6rem;
        border-radius: 4px;
        font-weight: 500;
    }
    .status-badge.pending {
        background: #fff3cd;
        color: #856404;
    }
    .status-badge.approved {
        background: #d4edda;
        color: #155724;
    }
    .status-badge.rejected {
        background: #f8d7da;
        color: #721c24;
    }
    
    .btn-sm {
        padding: 0.3rem 0.6rem;
        font-size: 0.8rem;
        border-radius: 4px;
        cursor: pointer;
        border: none;
        transition: all 0.3s ease;
    }
    .btn-review {
        background: #f0f7f2;
        color: #1BB64F;
    }
    .btn-review:hover {
        background: #1BB64F;
        color: white;
    }
    .btn-approve {
        background: #d4edda;
        color: #155724;
        margin-left: 0.5rem;
    }
    .btn-approve:hover {
        background: #155724;
        color: white;
    }
    
    @media (max-width: 768px) {
        .fraud-filters {
            flex-direction: column;
            align-items: flex-start;
        }
        .filter-group {
            width: 100%;
        }
        .form-select {
            width: 100%;
        }
    }
</style>
{% endblock %}

{% block content %}
<div class="content-header">
    <h1><i class="fas fa-flag"></i> Potential Fraud Cases</h1>
    <p>Detailed review of claims flagged as potentially fraudulent</p>
</div>

<!-- Tab Navigation -->
  <div
    style="
      display: flex;
      overflow-x: auto;
      gap: 0;
      margin-bottom: 0;
      scrollbar-width: none;
      border-bottom: 1px solid #e0e0e0;
      background: linear-gradient(to right, #f8f9fa, #f1f3f5);
    "
  >
    <a
      href=" "
      style="flex: 0 0 auto; padding: 1.2rem 2rem; background: {% if request.path == '/minet_forecast_volume/' %}#004b87{% else %}transparent{% endif %}; cursor: pointer; text-decoration: none; color: {% if request.path == '/minet_forecast_volume/' %}white{% else %}#004b87{% endif %}; border-right: 1px solid #e0e0e0; font-weight: 600; transition: all 0.3s ease; display: flex; align-items: center; gap: 0.8rem;"
    >
      <i class="fas fa-chart-line" style="font-size: 1.1rem"></i>
      Risk Scores
    </a>

    <a
      href="{% url 'minet_suspicious_providers' %}"
      style="flex: 0 0 auto; padding: 1.2rem 2rem; background: {% if request.path == '/minet_suspicious_providers/' %}#004b87{% else %}transparent{% endif %}; cursor: pointer; text-decoration: none; color: {% if request.path == '/minet_suspicious_providers/' %}white{% else %}#004b87{% endif %}; border-right: 1px solid #e0e0e0; font-weight: 600; transition: all 0.3s ease; display: flex; align-items: center; gap: 0.8rem;"
    >
      <i class="fas fa-chart-area" style="font-size: 1.1rem"></i>
      Suspicious providers
    </a>

    <a
      href=""
      style="flex: 0 0 auto; padding: 1.2rem 2rem; background: {% if request.path == '/minet_impact_simulation/' %}#004b87{% else %}transparent{% endif %}; cursor: pointer; text-decoration: none; color: {% if request.path == '/minet_impact_simulation/' %}white{% else %}#004b87{% endif %}; border-right: 1px solid #e0e0e0; font-weight: 600; transition: all 0.3s ease; display: flex; align-items: center; gap: 0.8rem;"
    >
      <i class="fas fa-cogs" style="font-size: 1.1rem"></i>
      Diagnosis Patterns
    </a>

    <a
      href="{% url 'minet_monthly_trends' %}"
      style="flex: 0 0 auto; padding: 1.2rem 2rem; background: {% if request.path == '/minet_monthly_trends/' %}#004b87{% else %}transparent{% endif %}; cursor: pointer; text-decoration: none; color: {% if request.path == '/minet_monthly_trends/' %}white{% else %}#004b87{% endif %}; border-right: 1px solid #e0e0e0; font-weight: 600; transition: all 0.3s ease; display: flex; align-items: center; gap: 0.8rem;"
    >
      <i class="fas fa-lightbulb" style="font-size: 1.1rem"></i>
      Monthly Trends
    </a>

    <a
      href="{% url 'minet_potential_cases' %}"
      style="flex: 0 0 auto; padding: 1.2rem 2rem; background: {% if request.path == '/minet_potential_cases/' %}#004b87{% else %}transparent{% endif %}; cursor: pointer; text-decoration: none; color: {% if request.path == '/minet_potential_cases/' %}white{% else %}#004b87{% endif %}; border-right: 1px solid #e0e0e0; font-weight: 600; transition: all 0.3s ease; display: flex; align-items: center; gap: 0.8rem;"
    >
      <i class="fas fa-lightbulb" style="font-size: 1.1rem"></i>
      Potential Cases
    </a>

    <a
      href="#"
      style="
        flex: 0 0 auto;
        padding: 1.2rem 2rem;
        background: transparent;
        cursor: pointer;
        text-decoration: none;
        color: #004b87;
        border-right: 1px solid #e0e0e0;
        font-weight: 600;
        transition: all 0.3s ease;
        display: flex;
        align-items: center;
        gap: 0.8rem;
      "
    >
      <i class="fas fa-shield-alt" style="font-size: 1.1rem"></i>
      Geospatial Heatmap
    </a>
  </div>

<div class="content-body">
    <form method="get" class="fraud-filters">
        <div class="filter-group">
            <label for="date-range">Date Range:</label>
            <select id="date-range" name="date_range" class="form-select" onchange="toggleCustomDate()">
                {% for dr in date_ranges %}
                <option value="{{ dr }}" {% if request.GET.date_range == dr %}selected{% endif %}>{{ dr }}</option>
                {% endfor %}
            </select>
        </div>

        <!-- Custom Range Date Pickers -->
        <div class="filter-group" id="custom-date-fields" style="display: none;">
            <label>Start Date:</label>
            <input type="date" name="start_date" value="{{ request.GET.start_date }}">
            <label>End Date:</label>
            <input type="date" name="end_date" value="{{ request.GET.end_date }}">
        </div>

        <div class="filter-group">
            <label for="risk-level">Risk Level:</label>
            <select id="risk-level" name="risk_level" class="form-select">
                {% for rl in risk_levels %}
                <option value="{{ rl }}" {% if request.GET.risk_level == rl %}selected{% endif %}>{{ rl }}</option>
                {% endfor %}
            </select>
        </div>

        <div class="filter-group">
            <label for="provider-filter">Provider:</label>
            <select id="provider-filter" name="provider" class="form-select">
                {% for p in providers %}
                    <option value="{{ p }}" {% if request.GET.provider == p %}selected{% endif %}>{{ p }}</option>
                {% endfor %}
            </select>
        </div>

        <button type="submit" class="btn btn-apply">
            <i class="fas fa-filter"></i> Apply Filters
        </button>
    </form>

    <div class="card">
        <div class="card-header">
            <h3>Flagged Claims</h3>
            <div class="card-actions">
                <button type="button" class="btn btn-export" onclick="exportTable()">
                    <i class="fas fa-download"></i> Export
                </button>
            </div>
        </div>
        <div class="card-body">
            <div class="table-responsive">
                <table class="fraud-cases-table" id="fraudTable">
                    <thead>
                        <tr>
                            <th><input type="checkbox" id="select-all"></th>
                            <th>Claim ID</th>
                            <th>Date</th>
                            <th>Member</th>
                            <th>Provider</th>
                            <th>Amount</th>
                            <th>Risk Score</th>
                            <th>Status</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for case in fraud_cases %}
                        <tr>
                            <td><input type="checkbox" class="case-checkbox"></td>
                            <td>{{ case.claim_id|default:"N/A" }}</td>
                            <td>{{ case.date|date:"Y-m-d" }}</td>
                            <td>{{ case.claim_me|default:"N/A" }}</td>
                            <td>{{ case.provider_name|default:"N/A" }}</td>
                            <td>KES {{ case.amount|floatformat:2 }}</td>
                            <td>
                                <div class="risk-score" style="--score: {{ case.fraud_score|default:0 }};">
                                    {{ case.fraud_score|floatformat:2 }}
                                </div>
                            </td>
                            <td>
                                <span class="status-badge pending">Pending</span>
                            </td>
                            <td>
                                <button class="btn btn-sm btn-review">Review</button>
                                <button class="btn btn-sm btn-approve">Approve</button>
                            </td>
                        </tr>
                        {% empty %}
                        <tr>
                            <td colspan="9" class="text-center">No potential fraud cases found</td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>

<script>
    // Handle Select All checkboxes
    document.getElementById('select-all').addEventListener('change', function() {
        document.querySelectorAll('.case-checkbox').forEach(cb => cb.checked = this.checked);
    });

    // Export Table to CSV
    function exportTable() {
        let csv = [];
        document.querySelectorAll("table tr").forEach(row => {
            let cols = row.querySelectorAll("td, th");
            let rowData = [];
            cols.forEach(col => rowData.push(col.innerText.trim()));
            csv.push(rowData.join(","));
        });
        let csvFile = new Blob([csv.join("\n")], { type: "text/csv" });
        let link = document.createElement("a");
        link.download = "potential_fraud_cases.csv";
        link.href = window.URL.createObjectURL(csvFile);
        link.click();
    }

    // Toggle Custom Date Range fields when "Custom Range" is selected
    function toggleCustomDate() {
        let dateRange = document.getElementById("date-range").value;
        let customFields = document.getElementById("custom-date-fields");
        customFields.style.display = (dateRange === "Custom Range") ? "flex" : "none";
    }

    // Run on page load to maintain state after filters
    document.addEventListener("DOMContentLoaded", function() {
        toggleCustomDate();
        
        // Initialize DataTables if table exists
        if ($.fn.DataTable.isDataTable('#fraudTable')) {
            $('#fraudTable').DataTable().destroy();
        }
        
        $('#fraudTable').DataTable({
            pageLength: 10,
            order: [[6, 'desc']], // Sort by risk score by default
            dom: 'lftip'
        });
    });
</script>
{% endblock %}