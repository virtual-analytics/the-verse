{% extends "base1.html" %}
{% load static %}

{% block title %}Geospatial Heatmap - Safaricom Portal{% endblock %}

{% block content %}
<div class="content-header">
    <h1><i class="fas fa-map-marked-alt"></i> Geospatial Heatmap</h1>
    <p>Visualization of fraud cases by geographic location</p>
</div>

<div class="content-body">
    <div class="card">
        <div class="card-header">
            <h3>Fraud Claim Density</h3>
            <div class="card-actions">
                <select id="map-style" class="form-select">
                    <option value="stamen-terrain">Terrain</option>
                    <option value="stamen-toner">Toner</option>
                    <option value="open-street-map">Street Map</option>
                    <option value="carto-positron">Light</option>
                </select>
            </div>
        </div>
        <div class="card-body">
            {% if visualizations.heatmap %}
                {{ visualizations.heatmap|safe }}
            {% else %}
                <div class="alert alert-warning">No geospatial data available</div>
            {% endif %}
        </div>
    </div>

    <div class="row">
        <div class="col-md-6">
            <div class="card">
                <div class="card-header">
                    <h3>High Risk Areas</h3>
                </div>
                <div class="card-body">
                    <div class="risk-areas">
                        <div class="risk-area">
                            <h4>Nairobi CBD</h4>
                            <div class="risk-metrics">
                                <div>
                                    <span class="metric-value">42</span>
                                    <span class="metric-label">Fraud Cases</span>
                                </div>
                                <div>
                                    <span class="metric-value">KES 1.2M</span>
                                    <span class="metric-label">Total Amount</span>
                                </div>
                                <div>
                                    <span class="metric-value">11.5%</span>
                                    <span class="metric-label">Fraud Rate</span>
                                </div>
                            </div>
                        </div>
                        <div class="risk-area">
                            <h4>Westlands</h4>
                            <div class="risk-metrics">
                                <div>
                                    <span class="metric-value">28</span>
                                    <span class="metric-label">Fraud Cases</span>
                                </div>
                                <div>
                                    <span class="metric-value">KES 850K</span>
                                    <span class="metric-label">Total Amount</span>
                                </div>
                                <div>
                                    <span class="metric-value">9.8%</span>
                                    <span class="metric-label">Fraud Rate</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-6">
            <div class="card">
                <div class="card-header">
                    <h3>Provider Locations</h3>
                </div>
                <div class="card-body">
                    <div id="provider-map"></div>
                </div>
            </div>
        </div>
    </div>
</div>

<style>
    .content-header {
        margin-bottom: 2rem;
    }
    
    .content-header h1 {
        color: #d62728;
        margin-bottom: 0.5rem;
    }
    
    .content-header p {
        color: #666;
    }
    
    .card {
        background: white;
        border-radius: 10px;
        box-shadow: 0 2px 10px rgba(0,0,0,0.05);
        margin-bottom: 2rem;
        border: 1px solid #e3e8ee;
    }
    
    .card-header {
        padding: 1.5rem;
        border-bottom: 1px solid #e3e8ee;
        display: flex;
        justify-content: space-between;
        align-items: center;
    }
    
    .card-header h3 {
        margin: 0;
        font-size: 1.2rem;
    }
    
    .card-body {
        padding: 1.5rem;
    }
    
    .form-select {
        padding: 0.5rem 1rem;
        border-radius: 6px;
        border: 1px solid #ddd;
        background-color: #f9f9f9;
    }
    
    .risk-areas {
        height: 100%;
    }
    
    .risk-area {
        margin-bottom: 1.5rem;
        padding-bottom: 1.5rem;
        border-bottom: 1px solid #e3e8ee;
    }
    
    .risk-area:last-child {
        margin-bottom: 0;
        padding-bottom: 0;
        border-bottom: none;
    }
    
    .risk-area h4 {
        color: #333;
        margin-bottom: 1rem;
    }
    
    .risk-metrics {
        display: grid;
        grid-template-columns: repeat(3, 1fr);
        gap: 1rem;
    }
    
    .risk-metrics div {
        text-align: center;
        background: #f7fdf9;
        padding: 1rem;
        border-radius: 6px;
    }
    
    .metric-value {
        font-size: 1.2rem;
        font-weight: 700;
        display: block;
        color: #d62728;
    }
    
    .metric-label {
        font-size: 0.8rem;
        color: #666;
        display: block;
    }
    
    #provider-map {
        height: 250px;
    }
</style>

<script>
    // Initialize provider map
    document.addEventListener('DOMContentLoaded', function() {
        // Sample data - replace with actual data from your backend
        const providerData = {
            names: ['Hospital A', 'Clinic B', 'Center C', 'Pharmacy D'],
            latitudes: [-1.2921, -1.2688, -1.3187, -1.3049],
            longitudes: [36.8219, 36.8039, 36.8172, 36.8384],
            fraudRates: [12.5, 8.3, 6.7, 5.2]
        };
        
        const trace = {
            type: 'scattermapbox',
            mode: 'markers',
            text: providerData.names,
            lon: providerData.longitudes,
            lat: providerData.latitudes,
            marker: {
                size: providerData.fraudRates.map(rate => rate * 2),
                color: providerData.fraudRates,
                colorscale: 'Reds',
                cmin: 0,
                cmax: 20,
                colorbar: {
                    title: 'Fraud Rate (%)'
                }
            }
        };
        
        const layout = {
            mapbox: {
                style: 'stamen-terrain',
                center: { lon: 36.8172, lat: -1.2921 },
                zoom: 11
            },
            margin: { t: 0, b: 0, l: 0, r: 0 },
            height: 250
        };
        
        Plotly.newPlot('provider-map', [trace], layout);
        
        // Handle map style change
        document.getElementById('map-style').addEventListener('change', function() {
            const style = this.value;
            console.log(`Changing map style to: ${style}`);
            // In a real app, you would update the map style
        });
    });
</script>
{% endblock %}